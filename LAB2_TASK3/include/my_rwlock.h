#ifndef _MY_RWLOCK_H_
#define _MY_RWLOCK_H_

#include <pthread.h>

/*
 * Собственная реализация блокировки чтения-записи (Read-Write Lock)
 * 
 * Структура включает:
 * - mutex: защищает внутреннее состояние rwlock
 * - readers_cv: условная переменная для ожидающих читателей
 * - writers_cv: условная переменная для ожидающих писателей
 * - active_readers: количество потоков, активно читающих
 * - waiting_readers: количество потоков, ожидающих чтения
 * - waiting_writers: количество потоков, ожидающих записи
 * - writer_active: флаг (0 или 1), активен ли писатель
 * 
 * Политика: Writer-preference (приоритет писателей)
 * Читатели не получают блокировку, если есть ожидающие писатели.
 * Это предотвращает голодание писателей.
 */
typedef struct {
    pthread_mutex_t mutex;           /* Защита внутреннего состояния */
    pthread_cond_t  readers_cv;      /* CV для ожидающих читателей */
    pthread_cond_t  writers_cv;      /* CV для ожидающих писателей */
    int             active_readers;  /* Число активных читателей */
    int             waiting_readers; /* Число ожидающих читателей */
    int             waiting_writers; /* Число ожидающих писателей */
    int             writer_active;   /* Флаг: писатель держит блокировку */
} my_rwlock_t;

/*
 * Инициализация rwlock
 * Возвращает 0 при успехе, код ошибки при неудаче
 */
int my_rwlock_init(my_rwlock_t* rwlock);

/*
 * Уничтожение rwlock
 * Освобождает ресурсы (mutex, condvars)
 * Возвращает 0 при успехе
 */
int my_rwlock_destroy(my_rwlock_t* rwlock);

/*
 * Получение блокировки на чтение
 * Блокирует поток, если активен писатель или есть ожидающие писатели
 * Несколько читателей могут держать блокировку одновременно
 * Возвращает 0 при успехе
 */
int my_rwlock_rdlock(my_rwlock_t* rwlock);

/*
 * Получение блокировки на запись
 * Блокирует поток, если есть активные читатели или активный писатель
 * Только один писатель может держать блокировку
 * Возвращает 0 при успехе
 */
int my_rwlock_wrlock(my_rwlock_t* rwlock);

/*
 * Освобождение блокировки (для чтения или записи)
 * Автоматически определяет тип блокировки по состоянию
 * Возвращает 0 при успехе
 */
int my_rwlock_unlock(my_rwlock_t* rwlock);

#endif /* _MY_RWLOCK_H_ */
